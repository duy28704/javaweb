<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{node_modules/bootstrap/dist/css/bootstrap.css}">
    <link rel="stylesheet" th:href="@{node_modules/bootstrap-icons/font/bootstrap-icons.css}">
    <link rel="stylesheet" th:href="@{css/dashboard.css}">
    <title>Danh sách người dùng</title>
</head>


<body>
    <header class="header d-flex fixed-top align-items-center row">
        <div class="d-flex align-items-center justify-content-between col-auto">
            <a th:href="@{dashboard.html}" class="logo d-flex align-items-center">
                <img th:src="@{img/6380171.jpg}" alt="">
                <span class="d-none d-lg-block">LaptopShop</span>
            </a>
            <i class="bi bi-list toggle-sidebar-btn"></i>
        </div>
        <div class="search-bar col-md-4 col-lg-5">
            <form class="search-form d-flex align-items-center" method="POST" action="#">
                <input type="text" name="query" placeholder="Tìm kiếm..." title="Enter search keyword">
                <button type="submit" title="Search"><i class="bi bi-search"></i></button>
            </form>
        </div>
        <nav class="header-nav ms-auto align-items-center col-auto ">
            <ul class="d-flex align-items-center ">
                <li class="nav-item dropdown">
                    <a class="nav-link nav-icon" href="#" data-bs-toggle="dropdown">
                        <i class="bi bi-bell"></i>
                        <span class="badge bg-primary badge-number">4</span>
                    </a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link nav-icon" href="#" data-bs-toggle="dropdown">
                        <i class="bi bi-chat-left-text"></i>
                        <span class="badge bg-success badge-number">3</span>
                    </a>
                </li>
                <li class="nav-item dropdown pe-3">

                    <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
                        <img th:src="@{assets/img/profile-img.jpg}" alt="Profile" class="rounded-circle mt-2">
                        <span class="d-none d-md-block dropdown-toggle ps-4 mt-4">Duy Vũ</span>
                    </a>

                    <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
                        <li class="dropdown-header">
                            <h6>Vô Danh</h6>
                            <span>Quản trị viên</span>
                        </li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li>
                            <a class="dropdown-item d-flex align-items-center" th:href="@{users-profile.html}">
                                <i class="bi bi-person"></i>
                                <span>Hồ sơ</span>
                            </a>
                        </li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li>
                            <a class="dropdown-item d-flex align-items-center" th:href="@{users-profile.html}">
                                <i class="bi bi-gear"></i>
                                <span>Cài đặt</span>
                            </a>
                        </li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li>
                            <a class="dropdown-item d-flex align-items-center" th:href="@{pages-faq.html}">
                                <i class="bi bi-question-circle"></i>
                                <span>Hỗ trợ</span>
                            </a>
                        </li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li>
                            <a class="dropdown-item d-flex align-items-center" th:href="@{login.html}">
                                <i class="bi bi-box-arrow-right"></i>
                                <span>Đăng xuất</span>
                            </a>
                        </li>
                    </ul>
                </li>
            </ul>
        </nav>
    </header>
    <aside id="sidebar" class="sidebar">
        <ul class="sidebar-nav" id="sidebar-nav">

            <li class="nav-item">
                <a class="nav-link " th:href="@{dashboard.html}">
                    <i class="bi bi-grid"></i>
                    <span>Dashboard</span>
                </a>
            </li>

            <li class="nav-item">
                <a class="nav-link [[${activeMenu == 'user'} ? '' : 'collapsed']]" data-bs-target="#components-nav"
                    data-bs-toggle="collapse" href="#">
                    <i class="bi bi-people"></i><span>Quản lí danh sách</span><i class="bi bi-chevron-down ms-3"></i>
                </a>

                <ul id="components-nav" class="nav-content collapse [[${activeMenu == 'user'} ? 'show' : '']]"
                    data-bs-parent="#sidebar-nav">
                    <li>
                        <a th:href="@{/user_list}" th:classappend="${activeMenu == 'user'} ? 'active'">
                            <i class="bi bi-person"></i><span>người sử dụng</span>
                        </a>
                    </li>
                </ul>
            </li>
            <li class="nav-item">
                <a class="nav-link collapsed" data-bs-target="#product-nav" data-bs-toggle="collapse" href="#">
                    <i class="bi bi-box-seam"></i><span>Quản lí sản phẩm</span><i class="bi bi-chevron-down ms-3"></i>
                </a>

                <ul id="product-nav" class="nav-content collapse " data-bs-parent="#sidebar-nav">
                    <li>
                        <a th:href="@{/productList}">
                            <i class="bi bi-collection"></i><span>Danh sách</span>
                        </a>
                    </li>
                    <li>
                        <a th:href="@{/bin}">
                            <i class="bi bi-trash"></i><span>Thùng rác</span>
                        </a>
                    </li>
                </ul>
            </li>
            <li class="nav-item">
                <a class="nav-link collapsed" data-bs-target="#support-nav" data-bs-toggle="collapse" href="#">
                    <i class="bi bi-telephone"></i><span>Liên hệ & hỗ trợ </span><i class="bi bi-chevron-down ms-3"></i>
                </a>

                <ul id="support-nav" class="nav-content collapse " data-bs-parent="#sidebar-nav">

                    <li>
                        <a href="add.html">
                            <i class="bi bi-envelope"></i><span>Hộp thư</span>
                        </a>
                    </li>
                    <li>
                        <a href="grant-permission.html">
                            <i class="bi bi-telephone-fill"></i><span>Tổng đài</span>
                        </a>
                    </li>
                    <li>
                        <a href="bin.html">
                            <i class="bi bi-shield-check"></i><span>Chính sách bảo hành</span>
                        </a>
                    </li>
                </ul>
            </li>
        </ul>
    </aside>
    <main class="mt-4">
        <h2 class="mt-4">Danh sách người dùng</h2>
        <div class="d-flex justify-content-end mb-2">
            <button type="button" class="btn btn-sm btn-success" title="Thêm người dùng" data-bs-toggle="modal"
                data-bs-target="#addModal">
                <i class="bi bi-plus-square me-1"></i> Thêm người dùng
            </button>
        </div>
        <table id="usersTable" class="table table-striped table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Ảnh đại diện</th>
                    <th>Họ tên</th>
                    <th>Trạng thái đăng nhập</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="user : ${users}">
                    <td th:text="${user.id}"></td>
                    <td>
                        <img th:src="@{${user.imageUrl}}" alt="Ảnh người dùng"
                            style="width: 50px; height: 50px; object-fit: cover;" />
                    </td>
                    </td>
                    <td th:text="${user.fullName}"></td>
                    <td th:text="${user.logined ? 'Đang online' : 'Ngoại tuyến'}"></td>
                    <td class="d-flex gap-2">

                        <button type="button" class="btn btn-sm btn-info" title="Xem chi tiết"
                            th:attr="data-user-id=${user.id}" data-bs-toggle="modal" data-bs-target="#viewModal">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-primary" title="Chỉnh sửa"
                            th:attr="data-user-id=${user.id}" data-bs-toggle="modal" data-bs-target="#editModal">
                            <i class="bi bi-pencil-square"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-danger" title="Xoá"
                            th:attr="data-user-id=${user.id}" data-bs-toggle="modal" data-bs-target="#deleteModal">
                            <i class="bi bi-trash"></i>
                        </button>

                    </td>
                </tr>
            </tbody>
        </table>
    </main>

    <div class="modal fade" id="viewModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Xem chi tiết</h5>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Họ tên:</strong> <span id="view-fullName"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Ngày sinh:</strong> <span id="view-birthday"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>SĐT:</strong> <span id="view-phone"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Email:</strong> <span id="view-email"></span></p>
                        </div>
                        <div class="col-md-12">
                            <p><strong>Địa chỉ:</strong> <span id="view-address"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Lĩnh vực:</strong> <span id="view-jobArea"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Công việc:</strong> <span id="view-job"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Chức vụ:</strong> <span id="view-position"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Năm ứng tuyển:</strong> <span id="view-applyYear"></span></p>
                        </div>
                        <div class="col-md-12">
                            <p><strong>Ghi chú:</strong> <span id="view-userNotes"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Vai trò:</strong> <span id="view-roles"></span></p>
                        </div>
                        <div class="col-md-12">
                            <p><strong>Hành động:</strong> <span id="view-userActions"></span></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button></div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="addUserForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addModalLabel">Thêm người dùng</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                    </div>
                    <div class="modal-body row g-3">
                        <div class="avatar-wrapper col-md-12 d-flex justify-content-center">
                            <img id="avatarPreview" th:src="@{/img/default.jpg}" class="avatar" alt="Chọn ảnh đại diện">
                            <input type="file" id="imageUrl" name="imageUrl" accept="image/*">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Tài khoản</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Mật khẩu</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Họ tên</label>
                            <input type="text" class="form-control" id="fullName">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Ngày sinh</label>
                            <input type="date" class="form-control" id="birthday">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Số điện thoại</label>
                            <input type="text" class="form-control" id="phone">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="email">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Địa chỉ</label>
                            <input type="text" class="form-control" id="address">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Vùng công tác</label>
                            <input type="text" class="form-control" id="jobArea">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Chức vụ</label>
                            <input type="text" class="form-control" id="position">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Nghề nghiệp</label>
                            <input type="text" class="form-control" id="job">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Năm ứng tuyển</label>
                            <input type="number" class="form-control" id="applyYear">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Ghi chú</label>
                            <textarea class="form-control" id="userNotes"></textarea>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Hành động</label>
                            <textarea class="form-control" id="userActions"></textarea>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Vai trò (role)</label>
                            <input type="text" class="form-control" id="roles" value="USER">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Lưu</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chỉnh sửa người dùng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="edit-id" name="id">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="edit-fullName" class="form-label">Họ và tên</label>
                                <input type="text" id="edit-fullName" name="fullName" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label for="edit-birthday" class="form-label">Ngày sinh</label>
                                <input type="date" id="edit-birthday" name="birthday" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label for="edit-phone" class="form-label">Số điện thoại</label>
                                <input type="text" id="edit-phone" name="phone" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label for="edit-email" class="form-label">Email</label>
                                <input type="email" id="edit-email" name="email" class="form-control">
                            </div>
                            <div class="col-12">
                                <label for="edit-address" class="form-label">Địa chỉ</label>
                                <input type="text" id="edit-address" name="address" class="form-control">
                            </div>
                            <div class="col-md-4">
                                <label for="edit-jobArea" class="form-label">Khu vực công việc</label>
                                <input type="text" id="edit-jobArea" name="jobArea" class="form-control">
                            </div>
                            <div class="col-md-4">
                                <label for="edit-job" class="form-label">Công việc</label>
                                <input type="text" id="edit-job" name="job" class="form-control">
                            </div>
                            <div class="col-md-4">
                                <label for="edit-position" class="form-label">Chức vụ</label>
                                <input type="text" id="edit-position" name="position" class="form-control">
                            </div>

                            <div class="col-md-4">
                                <label for="edit-applyYear" class="form-label">Năm ứng tuyển</label>
                                <input type="number" id="edit-applyYear" name="applyYear" class="form-control">
                            </div>
                            <div class="col-md-4">
                                <label for="edit-roles" class="form-label">Quyền</label>
                                <input type="text" id="edit-roles" name="roles" class="form-control">
                            </div>
                            <div class="col-12">
                                <label for="edit-userNotes" class="form-label">Ghi chú</label>
                                <textarea id="edit-userNotes" name="userNotes" class="form-control"></textarea>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button class="btn btn-primary" onclick="submitEditForm()">Lưu thay đổi</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Xác nhận xoá</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Bạn có chắc chắn muốn xoá người dùng có ID: <span id="delete-user-id"
                        class="fw-bold text-danger"></span>?
                    <input type="hidden" id="delete-user-id-hidden">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Huỷ</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete">Xoá</button>
                </div>
            </div>
        </div>
    </div>
    <footer>
        <div class="footer clearfix">
            <div class="copyright">
                &copy; 2025 LaptopShop
            </div>
        </div>
    </footer>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function () {
            $('#usersTable').DataTable({
                pageLength: 3,
                "language": {
                    "search": "Tìm kiếm:",
                    "lengthMenu": "Hiển thị _MENU_ dòng",
                    "info": "Hiển thị _START_ đến _END_ của _TOTAL_ dòng",
                    "paginate": {
                        "first": "Đầu",
                        "last": "Cuối",
                        "next": "Tiếp",
                        "previous": "Trước"
                    }
                }
            });
        });
    </script>
    <script>
        const viewModal = document.getElementById('viewModal');
        const editModal = document.getElementById('editModal');
        const deleteModal = document.getElementById('deleteModal');
        const addModal = document.getElementById('addModal');
        viewModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const userId = button.getAttribute('data-user-id');

            fetch(`/api/v1/users/user/${userId}`)
                .then(response => response.json())
                .then(user => {
                    document.getElementById("view-fullName").textContent = user.fullName;
                    document.getElementById("view-birthday").textContent = user.birthday;
                    document.getElementById("view-phone").textContent = user.phone;
                    document.getElementById("view-email").textContent = user.email;
                    document.getElementById("view-address").textContent = user.address;
                    document.getElementById("view-jobArea").textContent = user.jobArea;
                    document.getElementById("view-job").textContent = user.job;
                    document.getElementById("view-position").textContent = user.position;
                    document.getElementById("view-applyYear").textContent = user.applyYear;
                    document.getElementById("view-userNotes").textContent = user.userNotes;
                    document.getElementById("view-roles").textContent = user.roles;
                    document.getElementById("view-userActions").textContent = user.userActions;
                });
        });
        document.getElementById("addUserForm").addEventListener("submit", function (e) {
            e.preventDefault();

            const user = {
                username: document.getElementById("username").value,
                password: document.getElementById("password").value,
                fullName: document.getElementById("fullName").value,
                birthday: document.getElementById("birthday").value,
                phone: document.getElementById("phone").value,
                email: document.getElementById("email").value,
                address: document.getElementById("address").value,
                jobArea: document.getElementById("jobArea").value,
                job: document.getElementById("job").value,
                position: document.getElementById("position").value,
                applyYear: document.getElementById("applyYear").value,
                userNotes: document.getElementById("userNotes").value,
                userActions: document.getElementById("userActions").value,
                roles: document.getElementById("roles").value,
            };

            const formData = new FormData();
            formData.append("user", new Blob([JSON.stringify(user)], { type: "application/json" }));

            const imageFile = document.getElementById("imageUrl").files[0];
            if (imageFile) {
                formData.append("imageUrl", imageFile);
            }

            fetch("/api/v1/users/add", {
                method: "POST",
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text); });
                    }
                    return response.text();
                })
                .then(message => {
                    alert(message);
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addModal'));
                    modal.hide();
                    location.reload();
                })
                .catch(error => {
                    alert("Lỗi: " + error.message);
                });
        });
        editModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const userId = button.getAttribute('data-user-id');
            fetch(`/api/v1/users/user/${userId}`)
                .then(response => response.json())
                .then(user => {
                    document.getElementById('edit-id').value = user.id;
                    document.getElementById('edit-fullName').value = user.fullName;
                    document.getElementById('edit-birthday').value = user.birthday;
                    document.getElementById('edit-phone').value = user.phone;
                    document.getElementById('edit-email').value = user.email;
                    document.getElementById('edit-address').value = user.address;
                    document.getElementById('edit-jobArea').value = user.jobArea;
                    document.getElementById('edit-job').value = user.job;
                    document.getElementById('edit-position').value = user.position;
                    document.getElementById('edit-applyYear').value = user.applyYear;
                    document.getElementById('edit-userNotes').value = user.userNotes;
                    document.getElementById('edit-roles').value = user.roles;
                    document.getElementById('edit-logined').checked = user.logined;
                    document.getElementById('edit-userActions').value = user.userActions;
                });
        });
        function submitEditForm() {
            const form = document.getElementById('editForm');
            const formData = new FormData(form);
            const userId = formData.get("id");
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });

            fetch(`/api/v1/users/edit/${userId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => {
                    if (response.ok) {
                        alert("Cập nhật thành công!");
                        location.reload();
                    } else {
                        alert("Cập nhật thất bại.");
                    }
                })
                .catch(error => {
                    console.error("Lỗi khi gửi dữ liệu:", error);
                    alert("Đã xảy ra lỗi.");
                });
        }
        deleteModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const userId = button.getAttribute('data-user-id');
            document.getElementById('delete-user-id').textContent = userId;
            document.getElementById('delete-user-id-hidden').value = userId;
            document.getElementById('confirm-delete').addEventListener('click', function () {
                const userId = document.getElementById('delete-user-id-hidden').value;

                fetch(`/api/v1/users/delete/${userId}`, {
                    method: 'DELETE'
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => { throw new Error(text); });
                        }
                        return response.text();
                    })
                    .then(message => {
                        alert(message);
                        const modal = bootstrap.Modal.getInstance(deleteModal);
                        modal.hide();
                        location.reload();
                    })
                    .catch(error => {
                        alert(error.message);
                    });
            });

        });
    </script>
    <script>
        const avatar = document.getElementById("avatarPreview");
        const fileInput = document.getElementById("imageUrl");

        avatar.addEventListener("click", () => {
            fileInput.click();
        });

        fileInput.addEventListener("change", function () {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    avatar.src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        });
    </script>
</body>

</html>