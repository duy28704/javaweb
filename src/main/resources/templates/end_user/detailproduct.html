<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Chi tiết sản phẩm</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Sử dụng CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{assets/css/detailproduct.css}">
</head>
<div id="top-alert" class="alert alert-danger text-center" style="display: none;"></div>
<body>
<header>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" th:href="@{/}">ShopApp</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-between" id="navbarNav">
                <ul class="navbar-nav d-flex flex-row gap-3">
                    <li class="nav-item"><a class="nav-link active" th:href="@{/}">Trang chủ</a></li>
                    <li class="nav-item"><a class="nav-link" href="#">Thông báo</a></li>
                    <li class="nav-item"><a class="nav-link" th:href="@{/}">Sản phẩm</a></li>
                </ul>
                <ul class="navbar-nav d-flex flex-row gap-3">
                    <li class="nav-item"><a class="nav-link" href="#"><i class="fas fa-search"></i></a></li>
                    <li class="nav-item"><a class="nav-link" th:href="@{/order}"><i class="fas fa-shopping-cart"></i> Giỏ hàng</a></li>
                    <li class="nav-item"><a class="nav-link" th:href="@{/login}">Đăng nhập</a></li>
                </ul>
            </div>
        </div>
    </nav>
</header>

<div class="container mt-5">
    <h2 id="title" class="mb-4 text-center"></h2>
    <div class="row">
        <div class="col-md-6">
            <div class="main-image-container text-center mb-3">
                <img id="main-product-image" src="" class="img-fluid rounded" alt="Main Product Image" />
            </div>
            <div class="thumbnail-container mb-4"></div>
        </div>
        <div class="col-md-6">
            <h4>Thông tin chi tiết sản phẩm</h4>
            <div class="accordion" id="productAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cpuSpec">
                            Bộ xử lý
                        </button>
                    </h2>
                    <div id="cpuSpec" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <ul>
                                <li><strong>CPU:</strong> AMD Ryzen 5 7520U</li>
                                <li><strong>Số nhân:</strong> 4</li>
                                <li><strong>Số luồng:</strong> 8</li>
                                <li><strong>Xung nhịp:</strong> 2.8GHz - Boost 4.3GHz</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#ramSpec">
                            RAM &amp; Ổ cứng
                        </button>
                    </h2>
                    <div id="ramSpec" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <ul>
                                <li><strong>RAM:</strong> 16GB LPDDR5</li>
                                <li><strong>Bus:</strong> 5500 MHz</li>
                                <li><strong>Ổ cứng:</strong> SSD 512GB NVMe</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#screenSpec">
                            Màn hình
                        </button>
                    </h2>
                    <div id="screenSpec" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <ul>
                                <li><strong>Kích thước:</strong> 15.6"</li>
                                <li><strong>Độ phân giải:</strong> Full HD (1920 x 1080)</li>
                                <li><strong>Tần số:</strong> 60Hz</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#connectSpec">
                            Kết nối &amp; Âm thanh
                        </button>
                    </h2>
                    <div id="connectSpec" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <ul>
                                <li><strong>Cổng:</strong> USB-C, HDMI, Jack 3.5mm</li>
                                <li><strong>Kết nối:</strong> Wi-Fi 6, Bluetooth 5.3</li>
                                <li><strong>Loa:</strong> SonicMaster Audio</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <p class="mt-4">Giá: <strong id="price">12.690.000đ</strong></p>
            <div class="product-quantity mb-3">
                <label for="quantity" class="form-label">Số lượng:</label>
                <div class="d-flex align-items-center">
                    <button class="btn btn-outline-light px-3" onclick="changeQuantity(-1)">-</button>
                    <input
                            type="number"
                            id="quantity"
                            class="form-control text-center mx-2"
                            value="1"
                            min="1"
                            style="width: 80px; color: red;"
                    />
                    <button class="btn btn-outline-light px-3" onclick="changeQuantity(1)">+</button>
                    <span class="ms-3 text-muted">9993 sản phẩm có sẵn</span>
                </div>
                <div id="quantity-error" class="text-danger mt-1" style="display:none; font-size: 0.9em;"></div>
            </div>
            <div class="product-actions mb-3">
                <button class="btn btn-primary" onclick="addToCart()">Thêm vào giỏ hàng</button>
                <a th:href="@{/orderconfirm}" class="btn btn-success">Mua ngay</a>
            </div>
        </div>
    </div>
</div>
<div id="alertBox" class="alert-overlay d-none">
    <div class="alert-box">
        <h5>Đã thêm vào giỏ hàng thành công!</h5>
        <div class="mt-3">
            <button class="btn btn-secondary me-2" onclick="closeAlert()">Tiếp tục mua sắm</button>
            <a th:href="@{/order}" class="btn btn-primary">Đi tới giỏ hàng</a>
        </div>
    </div>
</div>
<div class="toast-container" id="toastContainer"></div>
<footer>
    <div class="footer bg-light py-3 mt-5">
        <div class="container">
            <div class="row footer-description">
                <div class="col-md-6">
                    <p>&copy; 2025 Your Company. All rights reserved.</p>
                </div>
                <div class="col-md-6">
                    <p class="text-end">Terms of Service | Privacy Policy</p>
                </div>
            </div>
        </div>
    </div>
</footer>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="/assets/js/filtered_images.js"></script>
<script>
    function changeQuantity(amount) {
      const qtyInput = document.getElementById('quantity');
      let current = parseInt(qtyInput.value);

      if (!isNaN(current)) {
        let updated = current + amount;

        // ❌ Không giới hạn nữa (cho phép 0 hoặc âm)
        // if (updated < 1) updated = 1;

        qtyInput.value = updated;
      }
}


    function validateProductInput() {
      const qtyInput = document.getElementById('quantity');
      const errorBox = document.getElementById('quantity-error');
      const value = qtyInput.value.trim();
      const number = parseInt(value);

      if (!value || isNaN(number) || number < 1) {
        errorBox.innerText = "Số lượng phải là số và lớn hơn 0.";
        errorBox.style.display = 'block';
        return false;
      }
      errorBox.style.display = 'none';
      return true;
    }

    function showTopAlert(message, isSuccess = false) {
      const alertBox = document.getElementById('top-alert');
      alertBox.className = 'alert text-center ' + (isSuccess ? 'alert-success' : 'alert-danger');
      alertBox.innerText = message;
      alertBox.style.display = 'block';

      setTimeout(() => {
        alertBox.style.display = 'none';
      }, 4000);
  }


    function showToast(message, isSuccess = true) {
      const toastContainer = document.getElementById('toastContainer');
      const toast = document.createElement('div');

      toast.className = 'toast ' + (isSuccess ? 'bg-success' : 'bg-danger');
      const timeString = new Date().toLocaleTimeString();

      toast.innerHTML = `${message}<small>${timeString}</small>`;
      toastContainer.appendChild(toast);

      setTimeout(() => toast.remove(), 4000);
    }


    function validateProductData() {
    const title = document.getElementById("title").innerText.trim();
    const quantityInput = document.getElementById("quantity");
    const quantity = parseInt(quantityInput.value);
    const price = 12690000;

    const errorBox = document.getElementById("quantity-error");

    if (title === "" || title === "Tên sản phẩm") {
      showTopAlert("Tên sản phẩm không hợp lệ!", false);
      return false;
    }

    if (isNaN(quantity) || quantity < 1) {
      errorBox.innerText = "Số lượng phải là số nguyên dương.";
      errorBox.style.display = "block";
      return false;
    } else {
      errorBox.style.display = "none";
    }

    if (isNaN(price) || price <= 0) {
      showTopAlert("Giá sản phẩm không hợp lệ!", false);
      return false;
    }

    showTopAlert("Dữ liệu sản phẩm hợp lệ. Có thể thêm vào giỏ hàng.", true);
    return true;
  }


    function addToCart() {
      if (!validateProductData()) return;

      const name = document.getElementById('title').innerText;
      const image = document.getElementById('main-product-image').src;
      const quantity = parseInt(document.getElementById('quantity').value);
      const price = 12690000;

      let cart = JSON.parse(localStorage.getItem('cart')) || [];

      const existing = cart.find(item => item.name === name);
      if (existing) {
        existing.quantity += quantity;
        showToast("Cập nhật số lượng sản phẩm trong giỏ hàng.");
      } else {
        cart.push({ name, image, quantity, price });
        showToast("Thêm sản phẩm mới vào giỏ hàng.");
      }

      localStorage.setItem('cart', JSON.stringify(cart));
      document.getElementById('alertBox').classList.remove('d-none');
    }

    function closeAlert() {
      document.getElementById('alertBox').classList.add('d-none');
    }

    document.addEventListener('DOMContentLoaded', function () {
      const params = new URLSearchParams(window.location.search);
      const productName = params.get('name');
      document.getElementById('title').innerText = productName || 'Tên sản phẩm';

      let images = filteredImages.find(item => item.name.trim() === productName?.trim())?.images || [];

      if (images.length === 0) {
        images = ["https://via.placeholder.com/600x600?text=No+Image"];
      }

      images = images.map(link => {
        if (link.startsWith('http')) return link;
        if (link.startsWith('//')) return 'https:' + link;
        return 'https://' + link;
      });

      const mainImage = document.getElementById('main-product-image');
      const thumbnailContainer = document.querySelector('.thumbnail-container');
      mainImage.src = images[0];

      thumbnailContainer.innerHTML = '';
      images.forEach((src, index) => {
        const thumb = document.createElement('img');
        thumb.src = src;
        thumb.className = 'thumbnail-image' + (index === 0 ? ' active' : '');
        thumb.addEventListener('click', () => {
          mainImage.src = src;
          document.querySelectorAll('.thumbnail-image').forEach(img => img.classList.remove('active'));
          thumb.classList.add('active');
        });
        thumbnailContainer.appendChild(thumb);
      });
    });
</script>
</body>
</html>