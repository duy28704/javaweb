<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <title>Trang đặt hàng</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" th:href="@{assets/css/order.css}">
</head>

<body>
<div class="container">
    <div class="intro-section">
        <!-- <h1>Đây là trang Order</h1>
        <p>Sử dụng Bootstrap</p> -->
    </div>

    <div class="row">
        <div class="col-md-6">
            <h2 class="product-header">Thông tin người nhận</h2>
            <form>
                <div class="mb-3">
                    <label for="name" class="form-label">Họ và tên</label>
                    <input type="text" class="form-control" id="name" />
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" />
                </div>
                <div class="mb-3">
                    <label for="phone" class="form-label">Số điện thoại</label>
                    <input type="text" class="form-control" id="phone" />
                </div>
                <div class="mb-3">
                    <label for="address" class="form-label">Địa chỉ</label>
                    <input type="text" class="form-control" id="address" />
                </div>
                <div class="mb-3">
                    <label for="delivery-time" class="form-label">Khoảng thời gian nhận hàng</label>
                    <select class="form-control" id="delivery-time">
                        <option>6:00 - 9:00</option>
                        <option>9:00 - 12:00</option>
                        <option>12:00 - 15:00</option>
                        <option>15:00 - 18:00</option>
                        <option>18:00 - 21:00</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="payment-method" class="form-label">Phương thức thanh toán</label>
                    <input type="text" class="form-control" id="payment-method" value="Thanh toán khi nhận hàng" readonly />
                </div>
            </form>
        </div>

        <div class="col-md-6">
            <h2 class="product-order">Sản phẩm đã đặt hàng</h2>
            <div class="table-wrapper mb-3">
                <table>
                    <thead>
                    <tr>
                        <th class="text-start">Sản phẩm</th>
                        <th>Số lượng</th>
                        <th>Đơn giá</th>
                        <th>Tổng giá</th>
                        <th>Hành động</th>
                    </tr>
                    </thead>
                    <tbody id="cart-body"></tbody>
                </table>
            </div>

            <div class="text-end">
                <h4 id="total-price">Tổng giá: 0 đ</h4>
            </div>

            <div class="mt-3">
                <h4 class="product-header">Nhập coupon</h4>
                <div class="input-group">
                    <input type="text" class="form-control" id="coupon-code" placeholder="Nhập coupon" />
                    <button class="btn btn-gradient" type="button" onclick="applyCoupon()">Áp dụng</button>
                </div>
            </div>

            <div class="mt-3 text-start">
                <button type="button" class="btn btn-gradient" onclick="validateAll()">Đặt hàng</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Xoá sản phẩm trong giỏ hàng
    function removeItem(index) {
      let cart = JSON.parse(localStorage.getItem("cart")) || [];
      cart.splice(index, 1);
      localStorage.setItem("cart", JSON.stringify(cart));
      location.reload();
    }

    // Áp dụng mã giảm giá
    function applyCoupon() {
      const code = document.getElementById("coupon-code").value.trim().toLowerCase();
      const totalPriceEl = document.getElementById("total-price");
      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      let total = cart.reduce((sum, item) => sum + item.quantity * item.price, 0);

      if (code === "phantruong") {
        const discount = Math.floor(total * 0.1);
        const discountedTotal = total - discount;
        totalPriceEl.innerText = `Tổng giá (đã giảm 10%): ${discountedTotal.toLocaleString()} đ`;
      } else {
        alert("Mã giảm giá không hợp lệ.");
        totalPriceEl.innerText = `Tổng giá: ${total.toLocaleString()} đ`;
      }
    }

    // Hiển thị giỏ hàng
    document.addEventListener("DOMContentLoaded", function () {
      // Gán sự kiện blur để kiểm tra từng ô khi rời khỏi
      ["name", "email", "phone", "address"].forEach(id => {
        const input = document.getElementById(id);
        input.addEventListener("blur", function () {
          validateField(input);
        });
      });

      // Hiển thị sản phẩm giỏ hàng
      const tbody = document.getElementById("cart-body");
      const totalPriceEl = document.getElementById("total-price");

      let cart = JSON.parse(localStorage.getItem("cart")) || [];
      let total = 0;

      cart.forEach((item, index) => {
        const itemTotal = item.quantity * item.price;
        total += itemTotal;

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>
            <div class="product-info">
              <img src="${item.image}" class="product-image" alt="">
              <span>${item.name}</span>
            </div>
          </td>
          <td>${item.quantity}</td>
          <td>${item.price.toLocaleString()} đ</td>
          <td>${itemTotal.toLocaleString()} đ</td>
          <td><button class="btn-remove" onclick="removeItem(${index})">Xoá</button></td>
        `;
        tbody.appendChild(row);
      });

      totalPriceEl.innerText = `Tổng giá: ${total.toLocaleString()} đ`;
    });

    // Hiển thị lỗi
    function showError(input, message) {
      let errorEl = input.nextElementSibling;
      if (!errorEl || !errorEl.classList.contains("error-msg")) {
        errorEl = document.createElement("div");
        errorEl.classList.add("error-msg");
        input.parentNode.appendChild(errorEl);
      }
      errorEl.innerText = message;
    }

    // Xoá lỗi
    function clearError(input) {
      let errorEl = input.nextElementSibling;
      if (errorEl && errorEl.classList.contains("error-msg")) {
        errorEl.remove();
      }
    }

    // Kiểm tra từng trường
    function validateField(input) {
      const value = input.value.trim();
      const id = input.id;

      if (id === "name") {
        if (!value) {
          showError(input, "Họ và tên không được để trống.");
          return false;
        }
        const nameRegex = /^[A-Za-zÀ-ỹ\s]+$/u;
        if (!nameRegex.test(value)) {
          showError(input, "Họ và tên chỉ được chứa chữ cái và khoảng trắng.");
          return false;
        }
      }

      if (id === "email") {
        if (!value) {
          showError(input, "Email không được để trống.");
          return false;
        }
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(value)) {
          showError(input, "Email không hợp lệ.");
          return false;
        }
      }

      if (id === "phone") {
        if (!value) {
          showError(input, "Số điện thoại không được để trống.");
          return false;
        }
        const phoneRegex = /^[0-9]{9,11}$/;
        if (!phoneRegex.test(value)) {
          showError(input, "Số điện thoại phải là số từ 9 đến 11 chữ số.");
          return false;
        }
      }

      if (id === "address") {
        if (!value) {
          showError(input, "Địa chỉ không được để trống.");
          return false;
        }
      }

      clearError(input);
      return true;
    }

    // Kiểm tra toàn bộ trước khi đặt hàng
function validateAll() {
  const fields = ["name", "email", "phone", "address"];
  let isValid = true;

  fields.forEach(id => {
    const input = document.getElementById(id);
    const valid = validateField(input);
    if (!valid) isValid = false;
  });

  const time = document.getElementById("delivery-time").value;
  if (!time) {
    alert("Vui lòng chọn khoảng thời gian nhận hàng.");
    isValid = false;
  }

  if (isValid) {
    alert("Đặt hàng thành công!");
    // Chuyển về trang chủ Spring Boot định tuyến qua controller
    window.location.href = '/';
  }
      return false; // ngăn form submit thực sự nếu bạn dùng form
    }
</script>
</body>
</html>
